---
import type { HTMLAttributes } from 'astro/types';

interface Props extends HTMLAttributes<'a'> {
  variant?: '' | 'platted' | 'platterless';
  size?: 'small' | 'medium' | 'large';
  wide?: 'fill' | 'fit';
  label?: 'icon-only' | 'text-only' | 'text-and-icon';
  isActive?: boolean; // Permite forzar el estado activo si es necesario
}

const {
  href,
  variant = 'text',
  size = 'medium',
  wide = 'auto',
  label,
  isActive: forceActive,
  class: className,
  ...props
} = Astro.props;

// 2. Lógica de URL y Estado Activo
const { pathname } = Astro.url;
const currentPath = pathname.replace(/\/$/, ''); // Normaliza la ruta actual (quita slash final)
const targetHref = href?.toString().replace(/\/$/, ''); // Normaliza el href

// Detecta si es la página actual o una sub-página
const isActive = forceActive ?? (
  targetHref === currentPath ||
  (targetHref !== '' && targetHref !== '/' && currentPath.startsWith(targetHref + '/'))
);

// 3. Lógica de Enlaces Externos (Seguridad)
const isExternal = href?.toString().startsWith('http');
// Si es externo, fuerza _blank y noopener. Si no, usa lo que venga en props o nada.
const target = isExternal ? '_blank' : props.target;
const rel = isExternal ? 'noopener noreferrer' : props.rel;

// 4. Clases dinámicas (BEM style o Utility classes)
const classes = [
  'anchor',
  `variant-${variant}`,
  `size-${size}`,
  `wide-${wide}`,
  label === 'icon' ? 'is-icon-only' : '',
  isActive ? 'is-active' : '', // Clase automática para CSS
  className
];
---

<a href={href} class:list={classes} target={target} rel={rel} aria-current={isActive ? 'page' : undefined} data-astro-prefetch={isExternal ? 'false' : 'viewport'} {...props}>
  <slot />
</a>

<style>
  @layer components {
    :is(a, a[role="button"]).anchor {
      height: fit-content;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-family-sans);
      font-weight: var(--font-weight-regular);
      text-align: center;
      backface-visibility: hidden;
      -webkit-font-smoothing: subpixel-antialiased;
      touch-action: manipulation;
      will-change: color, background-color, border-radius, transform;
      transition: color 105ms ease-out, background-color 105ms ease-out, border-radius 105ms ease-out, transform 105ms ease-out;
      &[aria-current="page"] {
        border-radius: 32px;
        color: var(--label-primary-active, oklch(0.99 0 0));
        background-color: var(--anchor-bg-active, oklch(0.22 0 0));
        cursor: default;
        pointer-events: none
      }
      @media (hover: hover) {
        &:hover {
          border-radius: 4px;
          transform: scale(1.03)
        }
      }
      &:active {
        border-radius: 4px;
        transform: scale(1.03)
      }
      &:focus-visible {
        outline: 2px solid var(--ring)
      }
      /* Variants */
      &.variant-platted {
        border-radius: 8px;
        border: 1px solid oklch(1 0 0 / 0.1);
        background: var(--fill-tertiary);
        background: oklch(0% 0 0 / 0.11);
        backdrop-filter: blur(20px);
        @media (hover: hover) {
          &:hover {
            --anchor-hover: okchl(1 1 1 / 0.08);
            background-color: var(--anchor-hover)
          }
        }
      }
      &.variant-platterless {
        
        @media (hover: hover) {
          &:hover {
            --anchor-hover: okchl(1 1 1 / 0.08);
            background-color: var(--anchor-hover)
          }
        }
      }
      /* Actions */
      &.action-default {
        color: var(--label-primary-controls);
        fill: var(--label-primary-controls)
      }
      &.action-neutral {
        color: var(--label-);
        fill: var(--label-)
      }
      /* Sizes */
      &.size-small {
        font-size: var(--font-size-12);
        &.label-text-and-icon {
          padding: 0px 0px;
          gap: 3px
        }
        &.label-text {
          padding: 0px 0px
        }
        &.label-icon {
          padding: 0px;
          border-radius: 50%
        }
        & svg {
          width: 24px;
          height: 24px
        }
      }
      &.size-medium {
        font-size: var(--font-size-14);
        &.label-text-and-icon {
          padding: 10px 14px;
          gap: 5px
        }
        &.label-text {
          padding: 10px 14px
        }
        &.label-icon {
          padding: 14px;
          border-radius: 50%
        }
        & svg {
          width: 32px;
          height: 32px
        }
      }
      &.size-large {
        font-size: var(--font-size-16);
        &.label-text-and-icon {
          padding: 12px 16px;
          gap: 6px
        }
        &.label-text {
          padding: 12px 16px
        }
        &.label-icon {
          padding: 16px
        }
        & svg {
          width: 40px;
          height: 40px
        }
      }
      /* Widths */
      &.wide-fit {
        width: fit-content
      }
      &.wide-fill {
        width: 100%
      }
      &[role="button"] {
        border-radius: 32px;
        &[aria-pressed="true"] {
          
        }
      }
      & svg { object-fit: cover }
    }
  }
</style>