---
import iconsIndex from '@data/icons.json';

// Importa todos los SVGs desde `src/assets/icons` usando import.meta.glob (eager/raw).
const modules = import.meta.glob('../../assets/icons/*.svg', { as: 'raw', eager: true });
const fileMap = new Map(Object.entries(modules).map(([p, content]) => {
  const file = p.split('/').pop() || '';
  const name = file.replace(/\.svg$/i, '');
  return [name, String(content)];
}));

// Construye un mapa de íconos usando las claves de icons.json -> contenido SVG.
const iconMap = new Map<string, string>();
for (const key of Object.keys(iconsIndex)) {
  const src = (iconsIndex as any)[key].src as string;
  const base = src.split('/').pop()?.replace(/\.svg$/i, '') || '';
  iconMap.set(key, fileMap.get(base) || '');
}

export interface Props {
  name: keyof typeof iconsIndex;
  class?: string;
  [key: string]: any;
}

const { name, class: className, ...rest } = Astro.props;
const raw = iconMap.get(name) || '';

// Procesa el SVG raw para inyectar clases en la etiqueta <svg> raíz.
let processed = raw;
if (raw) {
  processed = raw.replace(/^\s*<svg([^>]*)>/i, (match: string, existingAttrs: string) => {
    if (/\bclass\s*=/.test(existingAttrs)) {
      return `<svg${existingAttrs.replace(/class\s*=\s*("[^"]*"|'[^']*')/, (m: string, q: string) => {
        const existing = q.slice(1, -1);
        return `class="${existing} icon icon-${name}"`;
      })}>`;
    }
    return `<svg${existingAttrs} class="icon icon-${name}">`;
  });
}
---

<!--
** Ejemplos de uso:
* Ícono decorativo (por defecto)
<Icon name="arrow-up-right" />

* Ícono con significado y accesible para lectores de pantalla
<Icon name="email" title="Enviar correo" />

* Ícono con tamaño y clase personalizados
<Icon name="copy" class="text-blue-500" width="32" height="32" />
-->
{
  processed && (
    <span class={className} {...rest} set:html={processed} />
  )
}

<style>
  svg.icon {
    width: 1.2em;
    height: 1.2em;
    display: inline-block;
    vertical-align: middle;
    fill: currentColor
  }
</style>