---
// NewsletterForm.astro
import Button from '@components/Button.astro';

interface Props {
  buttonText?: string;
  placeholder?: string;
}

const { 
  buttonText = "Subscribe", 
  placeholder = "you@example.com" 
} = Astro.props;
---

<div class="newsletter-component">
  <form class="newsletter-form" novalidate aria-label="Newsletter subscription form">
    <div class="input-group">
      <div class="input-wrapper">
        <svg class="icon input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="20" height="16" x="2" y="4" rx="2"/>
          <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
        </svg>
        
        <input 
          type="email" 
          name="email" 
          placeholder={placeholder}
          autocomplete="email"
          required 
          class="form-input"
        />
      </div>

      <Button type="submit" class="submit-btn">
        <span class="content-idle">
          {buttonText}
        </span>
        
        <span class="content-loading">
          <svg class="icon spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          <span>Processing...</span>
        </span>

        <span class="content-success">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <span>Subscribed</span>
        </span>
      </Button>
    </div>

    <div class="message-area" aria-live="polite">
      <span class="msg error"></span>
      <span class="msg success"></span>
    </div>
  </form>
</div>

<script>
  // Lógica del cliente
  // Seleccionamos todos los formularios para que funcione si se usa el componente varias veces
  const forms = document.querySelectorAll('.newsletter-form');

  forms.forEach((form) => {
    const input = form.querySelector('input') as HTMLInputElement;
    const submitBtn = form.querySelector('button') as HTMLButtonElement;
    const msgError = form.querySelector('.msg.error') as HTMLElement;
    const msgSuccess = form.querySelector('.msg.success') as HTMLElement;
    
    // Regex original del componente Svelte [cite: 3]
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // Función auxiliar para establecer estado
    const setStatus = (status: 'idle' | 'loading' | 'success' | 'error', message = "") => {
      form.setAttribute('data-status', status);
      
      // Manejo de UI basado en estado
      if (status === 'error') {
        input.classList.add('error');
        input.setAttribute('aria-invalid', 'true');
        msgError.textContent = message;
        msgError.style.display = 'block';
        msgSuccess.style.display = 'none';
      } else if (status === 'success') {
        input.classList.remove('error');
        input.setAttribute('aria-invalid', 'false');
        msgSuccess.textContent = message;
        msgSuccess.style.display = 'block';
        msgError.style.display = 'none';
        input.value = ""; // Limpiar input [cite: 7]
      } else {
        // Idle o Loading
        input.classList.remove('error');
        input.setAttribute('aria-invalid', 'false');
        msgError.style.display = 'none';
        msgSuccess.style.display = 'none';
      }

      // Deshabilitar controles durante carga [cite: 12]
      const isLoading = status === 'loading' || status === 'success';
      input.disabled = isLoading;
      submitBtn.disabled = isLoading;
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = input.value;

      // 1. Validación Básica 
      if (!email || !emailRegex.test(email)) {
        setStatus('error', "Please enter a valid email address."); // [cite: 5]
        return;
      }

      // 2. Estado de Carga [cite: 5]
      setStatus('loading');

      try {
        // Simulación de API [cite: 6]
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        setStatus('success', "Thanks for subscribing! Check your inbox."); // [cite: 7]

        // Reset opcional [cite: 8]
        setTimeout(() => {
          setStatus('idle');
        }, 5000);

      } catch (err) {
        console.error(err);
        setStatus('error', "Something went wrong. Please try again later."); // [cite: 10]
      }
    });
  });
</script>

<style>
  .newsletter-component {
    width: 100%;
  }

  .newsletter-form {
    width: 100%;
    /* Variables para controlar visibilidad según data-status */
    --display-idle: block;
    --display-loading: none;
    --display-success: none;
  }

  /* Lógica de visualización basada en atributos data-status */
  .newsletter-form[data-status="loading"] {
    --display-idle: none;
    --display-loading: flex; /* Flex para alinear icono y texto */
    --display-success: none;
  }

  .newsletter-form[data-status="success"] {
    --display-idle: none;
    --display-loading: none;
    --display-success: flex;
  }

  /* Control de visibilidad del contenido del botón */
  .content-idle { display: var(--display-idle); }
  .content-loading { display: var(--display-loading); align-items: center; gap: 0.5rem; }
  .content-success { display: var(--display-success); align-items: center; gap: 0.5rem; }

  /* Estilos portados del original [cite: 16-29] */
  .input-group {
    display: flex;
    gap: 0.75rem; /* [cite: 16] */
    align-items: stretch;
  }

  @media (max-width: 480px) {
    .input-group {
      flex-direction: column; /* [cite: 16] */
    }
  }

  .input-wrapper {
    position: relative;
    flex-grow: 1;
    display: flex;
    align-items: center;
  }

  .icon {
    display: inline-block;
    vertical-align: middle;
  }

  .input-icon {
    position: absolute;
    left: 0.75rem;
    color: #888;
    pointer-events: none; /* [cite: 19] */
  }

  input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem; /* Padding izquierdo para icono [cite: 21] */
    border: 1px solid #ccc;
    border-radius: 0.5rem;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s; /* [cite: 22] */
    background-color: #fff;
    color: #111;
  }

  input:focus {
    border-color: #3b82f6; /* Azul [cite: 23] */
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  input.error {
    border-color: #ef4444; /* Rojo [cite: 24] */
  }

  input:disabled {
    opacity: 0.7;
    cursor: not-allowed; /* [cite: 25] */
    background-color: #f9fafb;
  }

  /* Animación Spin [cite: 26] */
  .spin {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Mensajes [cite: 27] */
  .message-area {
    min-height: 1.5rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
  }

  .msg {
    display: none; /* Oculto por defecto en JS */
    /* Transición suave para simular el fade de Svelte */
    animation: fadeIn 0.2s ease-in-out; 
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .msg.error {
    color: #ef4444; /* [cite: 29] */
  }

  .msg.success {
    color: #16a34a; /* [cite: 29] */
  }
</style>